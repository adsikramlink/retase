<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mining Dashboard v9 (AutoSave)</title>
    <style>
        /* --- CSS BASE --- */
        :root { --primary: #4f46e5; --bg: #f1f5f9; --slate-900: #0f172a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #1e293b; margin: 0; padding: 0; height: 100vh; overflow: hidden; }

        /* NAVIGASI */
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background: var(--bg); display: none; padding-bottom: 100px; }
        .page.active { display: block; }
        .navbar { background: var(--slate-900); color: white; padding: 16px; position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* KOMPONEN */
        .container { max-width: 768px; margin: 16px auto; padding: 0 16px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; overflow: hidden; }
        .card-header { background: #f8fafc; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-weight: bold; font-size: 14px; color: #334155; display:flex; justify-content:space-between; align-items:center; }
        .card-body { padding: 16px; }

        /* INPUTS */
        .input-base { width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; font-weight: 600; outline: none; margin-bottom: 8px; }
        .input-manual { width: 100%; border: none; border-bottom: 1px solid #e2e8f0; padding: 4px 0; outline: none; font-size: 14px; }
        
        /* CHIPS */
        .chip-label input:checked + div { background-color: var(--primary); color: white; border-color: var(--primary); }
        .chip-div { padding: 4px 10px; border-radius: 99px; border: 1px solid #cbd5e1; background: white; color: #64748b; font-size: 11px; font-weight: 700; display: inline-block; margin-right: 4px; margin-bottom: 4px; cursor: pointer; }

        /* CONVEYOR */
        .tab-scroll { display: flex; overflow-x: auto; gap: 5px; padding-bottom: 5px; margin-bottom: 10px; }
        .tab-btn { white-space: nowrap; padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 700; color: #64748b; background: transparent; border: 1px solid transparent; }
        .tab-btn.active { background: #e0e7ff; color: var(--primary); border-color: #c7d2fe; }

        /* TIME & TABLES */
        .grid-cols-12 { display: grid; grid-template-columns: repeat(12, 1fr); gap: 4px; }
        .col-span-1 { grid-column: span 1; } .col-span-2 { grid-column: span 2; } 
        .col-span-4 { grid-column: span 4; } .col-span-5 { grid-column: span 5; }
        .col-span-6 { grid-column: span 6; }
        
        .time-box { display: flex; align-items: center; justify-content: center; gap: 2px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px; }
        .time-digit { width: 30px; text-align: center; border: none; outline: none; font-weight: 700; color: #334155; }
        .table-input { width: 100%; text-align: center; background: transparent; border: none; border-bottom: 2px solid #e2e8f0; font-weight: 700; padding: 4px; outline: none; }
        
        /* UTILS */
        .fab-add { position: fixed; bottom: 24px; right: 24px; background: var(--primary); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); z-index: 100; cursor: pointer; }
        .history-item { background: white; padding: 16px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* SETTINGS */
        .master-group { margin-bottom: 20px; }
        .master-label { font-size: 11px; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .master-list-item { display: flex; justify-content: space-between; background: white; padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; font-weight: bold; }
        .btn-del { color: #ef4444; background: none; border: none; font-weight: bold; }
        .add-row { display: flex; gap: 8px; margin-top: 5px; }
        .pt-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .bg-c-0 { background: orange; } .bg-c-1 { background: green; } .bg-c-2 { background: #ca8a04; } .bg-c-3 { background: #2563eb; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div class="navbar">
            <div><h1 style="margin:0; font-size:18px;">Mining Dashboard</h1><span style="font-size:10px; opacity:0.8">v9.0 AutoSave</span></div>
            <button onclick="nav('settings')" style="background:none; border:none; font-size:20px;">‚öôÔ∏è</button>
        </div>
        <div class="container">
            <div id="history-list"></div>
            <div id="empty-msg" style="text-align:center; margin-top:100px; color:#cbd5e1; display:none;">
                <div style="font-size:40px">üìÇ</div><p>Belum ada data</p>
            </div>
        </div>
        <button onclick="openForm()" class="fab-add">+</button>
    </div>

    <div id="page-form" class="page">
        <div class="navbar">
            <button onclick="nav('home')" style="background:none; border:none; color:white;">‚Üê Tutup</button>
            <span style="font-weight:bold">Input Data</span>
            <button onclick="manualSave()" style="background:#22c55e; border:none; color:white; padding:6px 12px; border-radius:4px; font-weight:bold;">‚úî SIMPAN</button>
        </div>

        <div class="container">
            <div class="card">
                <div class="card-header">0. Data Operasional</div>
                <div class="card-body">
                    <div class="grid-2">
                        <div><label class="master-label">Shift</label><select id="inpShift" class="input-base"><option value="NIGHT SHIFT">üåô NIGHT SHIFT</option><option value="DAY SHIFT">‚òÄÔ∏è DAY SHIFT</option></select></div>
                        <div><label class="master-label">Tanggal</label><input type="date" id="inpDate" class="input-base"></div>
                    </div>
                    
                    <label class="master-label">SUPERVISOR</label><div id="box-spv"></div><input id="inpSpvM" placeholder="+ Manual" class="input-manual">
                    <label class="master-label" style="margin-top:8px">FOREMAN</label><div id="box-frm"></div><input id="inpFrmM" placeholder="+ Manual" class="input-manual">
                    <label class="master-label" style="margin-top:8px">CHECKER</label><div id="box-chk"></div><input id="inpChkM" placeholder="+ Manual" class="input-manual">

                    <div class="grid-2" style="margin-top:10px">
                        <div style="background:#eff6ff; padding:8px; border-radius:6px; border:1px solid #bfdbfe"><label class="master-label" style="color:blue">TIPPING ROM</label><input type="number" id="inpTip" placeholder="0" class="input-manual" style="font-size:18px; font-weight:bold; background:transparent"></div>
                        <div style="background:#ecfdf5; padding:8px; border-radius:6px; border:1px solid #a7f3d0"><label class="master-label" style="color:green">TRANSFER ROM</label><input type="number" id="inpTrans" placeholder="0" class="input-manual" style="font-size:18px; font-weight:bold; background:transparent"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>1. Durasi Conveyor</span>
                    <div id="conv-tabs" class="tab-scroll"></div>
                </div>
                <div class="card-body">
                    <div class="grid-cols-12" style="text-align:center; font-size:10px; font-weight:bold; color:#94a3b8; margin-bottom:5px;">
                        <div class="col-span-1">#</div><div class="col-span-5">Mulai</div><div class="col-span-5">Selesai</div><div class="col-span-1">Del</div>
                    </div>
                    <div id="conv-contents"></div>
                    <button onclick="addTimeRow()" style="width:100%; padding:8px; margin-top:10px; border:1px dashed #cbd5e1; background:white; color:#64748b; font-weight:bold; border-radius:6px;">+ Tambah Jam</button>
                    <div class="grid-2" style="margin-top:15px; border-top:1px solid #f1f5f9; padding-top:10px; text-align:center;">
                        <div><div class="master-label">INDIKASI</div><div id="res-val" style="font-size:16px; font-weight:900">-</div></div>
                        <div><div class="master-label">EFEKTIVITAS</div><div id="eff-val" style="font-size:14px; font-weight:bold">-</div></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">2. Perhitungan Unit & Trip</div>
                <div class="card-body">
                    <div id="hauling-rows"></div>
                    <div style="background:#f1f5f9; padding:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <span style="font-weight:bold; color:#64748b">Total Hauling</span>
                        <span id="grand-total" style="font-weight:900; color:var(--primary); font-size:18px;">0</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">3. Unit SDT Running <button onclick="nav('settings')" style="font-size:10px; border:1px solid #cbd5e1; background:white; padding:2px 6px; border-radius:4px;">+ Master Unit</button></div>
                <div class="card-body">
                    <div id="box-unit-btns" style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:10px;"></div>
                    <div id="sdt-list"></div>
                    <div id="sdt-empty" style="text-align:center; padding:20px; color:#cbd5e1; font-style:italic; font-size:12px; border:1px dashed #e2e8f0; border-radius:6px;">List Kosong</div>
                </div>
            </div>

            <div class="grid-2">
                <button onclick="copyReport(false)" style="background:white; border:1px solid #d8b4fe; color:#7e22ce; padding:12px; border-radius:8px; font-weight:bold;">Salin SIANG</button>
                <button onclick="copyReport(true)" style="background:white; border:1px solid #c7d2fe; color:#4338ca; padding:12px; border-radius:8px; font-weight:bold;">Salin MALAM</button>
            </div>
        </div>
    </div>

    <div id="page-settings" class="page">
        <div class="navbar">
            <button onclick="nav('home')" style="background:none; border:none; color:white;">‚Üê Kembali</button>
            <span>Pengaturan Master</span>
            <div style="width:20px"></div>
        </div>
        <div class="container">
            <div class="card">
                <div class="card-header">Personil</div>
                <div class="card-body">
                    <div class="master-group"><label class="master-label">SUPERVISOR</label><div id="list-m-spv"></div><div class="add-row"><input id="new-spv" class="input-base"><button onclick="addM('spv')" class="input-base" style="width:40px;background:var(--primary);color:white">+</button></div></div>
                    <div class="master-group"><label class="master-label">FOREMAN</label><div id="list-m-frm"></div><div class="add-row"><input id="new-frm" class="input-base"><button onclick="addM('frm')" class="input-base" style="width:40px;background:var(--primary);color:white">+</button></div></div>
                    <div class="master-group"><label class="master-label">CHECKER</label><div id="list-m-chk"></div><div class="add-row"><input id="new-chk" class="input-base"><button onclick="addM('chk')" class="input-base" style="width:40px;background:var(--primary);color:white">+</button></div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Operasional</div>
                <div class="card-body">
                    <div class="master-group"><label class="master-label">CONVEYOR (SD)</label><div id="list-m-conv"></div><div class="add-row"><input id="new-conv" class="input-base"><button onclick="addM('conv')" class="input-base" style="width:40px;background:var(--primary);color:white">+</button></div></div>
                    <div class="master-group"><label class="master-label">PT / KONTRAKTOR</label><div id="list-m-pt"></div><div class="add-row"><input id="new-pt" class="input-base"><button onclick="addM('pt')" class="input-base" style="width:40px;background:var(--primary);color:white">+</button></div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Unit SDT & Driver</div>
                <div class="card-body">
                    <div class="master-group"><label class="master-label">UNIT SDT</label><div id="list-m-unit"></div><div class="add-row"><input id="new-unit" class="input-base"><button onclick="addM('unit')" class="input-base" style="width:40px;background:var(--primary);color:white">+</button></div></div>
                    <div class="master-group"><label class="master-label">DRIVER</label><div id="list-m-driver"></div><div class="add-row"><input id="new-driver" class="input-base"><button onclick="addM('driver')" class="input-base" style="width:40px;background:var(--primary);color:white">+</button></div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA DEFAULT ---
        const DEF = {
            spv: ['Ihsan R', 'Dicky F', 'Sopian'],
            frm: ['Gunawan TC', 'Hardiansyah', 'Lewi S', 'Elimelek J'],
            chk: ['Indra R', 'Jemmie P', 'Ikram', 'Fahri T'],
            conv: ['SD1', 'SD2', 'SD3'],
            pt: ['MHA', 'KARUNIA', 'BUMA'],
            unit: ["01-F", "02-F", "03-F", "3A-F", "05-F"],
            driver: ["Jeksen", "Saipul", "Julio"]
        };
        let masters = {}, activeConv = '', convData = {}, sdtData = [], currentId = null;

        window.onload = () => {
            loadMasters();
            loadHistoryList();
            document.getElementById('inpDate').valueAsDate = new Date();
        };

        function nav(p) {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            if(p==='settings') renderSettings();
            if(p==='home') loadHistoryList();
        }

        function openForm(id=null) {
            currentId = id; nav('form'); renderFormUI();
            if(id) loadFormData(id); else resetForm();
        }

        function loadMasters() {
            ['spv','frm','chk','conv','pt','unit','driver'].forEach(k => {
                const ls = localStorage.getItem(`m_${k}`);
                masters[k] = ls ? JSON.parse(ls) : [...DEF[k]];
            });
        }
        function saveM() {
            ['spv','frm','chk','conv','pt','unit','driver'].forEach(k => localStorage.setItem(`m_${k}`, JSON.stringify(masters[k])));
            renderSettings();
        }
        function addM(k) {
            const v = document.getElementById(`new-${k}`).value.toUpperCase().trim();
            if(v && !masters[k].includes(v)) { masters[k].push(v); document.getElementById(`new-${k}`).value=''; saveM(); }
        }
        function delM(k, idx) { if(confirm('Hapus?')) { masters[k].splice(idx,1); saveM(); } }

        function renderFormUI() {
            const renC = (id, l) => document.getElementById(id).innerHTML = l.map(t=>`<label class="chip-label"><input type="checkbox" value="${t}" class="hidden"><div class="chip-div">${t}</div></label>`).join('');
            renC('box-spv', masters.spv); renC('box-frm', masters.frm); renC('box-chk', masters.chk);

            const tC = document.getElementById('conv-tabs'), cC = document.getElementById('conv-contents');
            tC.innerHTML = masters.conv.map(c=>`<button onclick="switchConv('${c}')" id="tab-${c}" class="tab-btn">${c}</button>`).join('');
            cC.innerHTML = masters.conv.map(c=>`<div id="cont-${c}" class="hidden"></div>`).join('');
            masters.conv.forEach(c=>{ if(!convData[c]) convData[c]=[]; });
            if(masters.conv.length>0) switchConv(masters.conv[0]);

            document.getElementById('hauling-rows').innerHTML = masters.pt.map((pt,i)=>`
                <div style="margin-bottom:15px;"><div style="display:flex;align-items:center;gap:5px;margin-bottom:5px;"><span class="pt-dot bg-c-${i%5}"></span><span style="font-weight:bold;font-size:12px;">${pt}</span></div>
                <div style="border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;"><div class="grid-cols-12" style="background:#f8fafc;font-size:10px;font-weight:bold;color:#94a3b8;text-align:center;padding:5px 0;"><div class="col-span-2">SHIFT</div><div class="col-span-4">UNIT</div><div class="col-span-4">TRIP</div><div class="col-span-2">HSL</div></div>
                <div class="grid-cols-12" style="align-items:center;text-align:center;padding:5px 0;border-bottom:1px solid #f1f5f9;"><div class="col-span-2">‚òÄÔ∏è</div><div class="col-span-4 px-1"><input type="number" id="run-s-${pt}" class="table-input" placeholder="0" oninput="calcHauling('${pt}')"></div><div class="col-span-4 px-1"><input type="number" id="trip-s-${pt}" class="table-input" placeholder="0" oninput="calcHauling('${pt}')"></div><div class="col-span-2 font-black" id="res-s-${pt}">0</div></div>
                <div class="grid-cols-12" style="align-items:center;text-align:center;padding:5px 0;background:#fcfcfc;"><div class="col-span-2">üåô</div><div class="col-span-4 px-1"><input type="number" id="run-m-${pt}" class="table-input" placeholder="0" oninput="calcHauling('${pt}')"></div><div class="col-span-4 px-1"><input type="number" id="trip-m-${pt}" class="table-input" placeholder="0" oninput="calcHauling('${pt}')"></div><div class="col-span-2 font-black" id="res-m-${pt}">0</div></div></div></div>`).join('');

            document.getElementById('box-unit-btns').innerHTML = masters.unit.map(u=>`<button onclick="addSdt('${u}')" style="background:white;border:1px solid #cbd5e1;font-size:11px;padding:4px 8px;border-radius:4px;font-weight:bold;color:#475569">${u}</button>`).join('');
        }

        function switchConv(n) {
            activeConv=n; masters.conv.forEach(c=>{ document.getElementById(`tab-${c}`).classList.remove('active'); document.getElementById(`cont-${c}`).classList.add('hidden'); });
            document.getElementById(`tab-${n}`).classList.add('active'); document.getElementById(`cont-${n}`).classList.remove('hidden'); calcConv();
        }
        function addTimeRow(n=activeConv) { if(!convData[n]) convData[n]=[]; convData[n].push({sh:'',sm:'',fh:'',fm:''}); renderConvRows(n); }
        function renderConvRows(n) {
            document.getElementById(`cont-${n}`).innerHTML = convData[n].map((d,i)=>`<div class="grid-cols-12" style="margin-bottom:5px;align-items:center;"><div class="col-span-1" style="text-align:center;font-size:10px;color:#cbd5e1;">${i+1}</div><div class="col-span-5 time-box"><input type="tel" value="${d.sh}" class="time-digit" oninput="updT('${n}',${i},'sh',this)">:<input type="tel" value="${d.sm}" class="time-digit" oninput="updT('${n}',${i},'sm',this)"></div><div class="col-span-5 time-box"><input type="tel" value="${d.fh}" class="time-digit" oninput="updT('${n}',${i},'fh',this)">:<input type="tel" value="${d.fm}" class="time-digit" oninput="updT('${n}',${i},'fm',this)"></div><div class="col-span-1" style="text-align:center;"><button onclick="delT('${n}',${i})" style="color:red;background:none;border:none;font-weight:bold;">√ó</button></div></div>`).join(''); calcConv();
        }
        function updT(n,i,f,el) { let v=el.value.replace(/\D/g,''); if(v.length>2) v=v.slice(0,2); convData[n][i][f]=v; calcConv(); }
        function delT(n,i) { convData[n].splice(i,1); renderConvRows(n); }
        function calcConv() {
            let tot=0; (convData[activeConv]||[]).forEach(d=>{ if(d.sh&&d.sm&&d.fh&&d.fm){ let s=parseInt(d.sh)*60+parseInt(d.sm), f=parseInt(d.fh)*60+parseInt(d.fm); if(f<s) f+=1440; tot+=(f-s); }});
            const th=Math.floor(tot/60), tm=tot%60; document.getElementById('res-val').innerText=`${th}j ${tm}m`;
            let rem=(12*60)-tot; const rh=Math.floor(Math.abs(rem)/60), rm=Math.abs(rem)%60; 
            const el=document.getElementById('eff-val');
            if(tot===0){ el.innerText='-'; el.style.color="#cbd5e1"; } else if(rem>=0){ el.innerText=`${rh}j ${rm}m`; el.style.color="green"; } else { el.innerText=`${rh}j ${rm}m (Over)`; el.style.color="red"; }
        }

        function calcHauling(pt) {
            const v=(id)=>parseFloat(document.getElementById(id).value)||0;
            const rs=v(`run-s-${pt}`), ts=v(`trip-s-${pt}`), rm=v(`run-m-${pt}`), tm=v(`trip-m-${pt}`);
            document.getElementById(`res-s-${pt}`).innerText=ts-rs; document.getElementById(`res-m-${pt}`).innerText=(tm-ts)-rm;
            let tot=0; masters.pt.forEach(p=> tot+=(v(`trip-m-${p}`)-v(`trip-s-${p}`)));
            document.getElementById('grand-total').innerText=tot+" Trip";
        }

        function addSdt(u) { sdtData.push({unit:u,driver:'',trip:'',ket:''}); renderSdt(); }
        function renderSdt() {
            const c=document.getElementById('sdt-list');
            if(sdtData.length===0){ c.innerHTML=''; document.getElementById('sdt-empty').style.display='block'; return; }
            document.getElementById('sdt-empty').style.display='none';
            const opts=`<option value="">Supir...</option>`+masters.driver.map(d=>`<option value="${d}">${d}</option>`).join('');
            c.innerHTML=sdtData.map((d,i)=>`<div style="background:#f8fafc;border:1px solid #e2e8f0;padding:8px;border-radius:6px;margin-bottom:6px;"><div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span style="font-weight:bold;background:#dbeafe;padding:2px 8px;border-radius:4px;font-size:12px;color:#1e40af">${d.unit}</span><span onclick="sdtData.splice(${i},1);renderSdt();" style="color:red;font-size:12px;font-weight:bold;cursor:pointer;">Hapus</span></div>
            <div class="grid-cols-12">
                <div class="col-span-4"><select onchange="sdtData[${i}].driver=this.value" class="input-base" style="margin:0;padding:4px;">${opts.replace(`value="${d.driver}"`,`value="${d.driver}" selected`)}</select></div>
                <div class="col-span-2"><input type="number" placeholder="Trip" value="${d.trip}" oninput="sdtData[${i}].trip=this.value" class="input-base" style="margin:0;text-align:center;padding:4px;"></div>
                <div class="col-span-6"><input placeholder="Ket" value="${d.ket}" oninput="sdtData[${i}].ket=this.value" class="input-base" style="margin:0;padding:4px;color:red;"></div>
            </div></div>`).join('');
        }

        function resetForm() {
            document.querySelectorAll('input').forEach(i=>i.value=''); document.querySelectorAll('input[type=checkbox]').forEach(i=>i.checked=false);
            convData={}; masters.conv.forEach(c=>{ convData[c]=[]; addTimeRow(c); addTimeRow(c); addTimeRow(c); addTimeRow(c); }); renderConvRows(masters.conv[0]);
            sdtData=[]; renderSdt(); masters.pt.forEach(p=>{ const s=document.getElementById(`res-s-${p}`), m=document.getElementById(`res-m-${p}`); if(s)s.innerText='0'; if(m)m.innerText='0'; });
            document.getElementById('grand-total').innerText="0";
        }

        function manualSave() { saveData(); alert('Tersimpan!'); nav('home'); }

        function saveData() {
            const getC=(id)=>Array.from(document.querySelectorAll(`#${id} input:checked`)).map(e=>e.value);
            const val=(id)=>document.getElementById(id).value;
            let ptD={}; masters.pt.forEach(p=>{ ptD[p]={rs:val(`run-s-${p}`),ts:val(`trip-s-${p}`),rm:val(`run-m-${p}`),tm:val(`trip-m-${p}`)}});
            
            // Total calculation for history summary
            let totalTrip = 0;
            masters.pt.forEach(p=> totalTrip+=(val(`trip-m-${p}`)-val(`trip-s-${p}`)));

            const d={
                id: currentId || Date.now(),
                date: val('inpDate'), shift: val('inpShift'),
                spv: getC('box-spv'), spv_m: val('inpSpvM'),
                frm: getC('box-frm'), frm_m: val('inpFrmM'),
                chk: getC('box-chk'), chk_m: val('inpChkM'),
                rom: {tip:val('inpTip'),trans:val('inpTrans')},
                conv: convData, pt: ptD, sdt: sdtData,
                totalTrip: document.getElementById('grand-total').innerText
            };
            
            let h=JSON.parse(localStorage.getItem('m_v9')||'[]'); 
            if(currentId){
                const i=h.findIndex(x=>x.id===currentId);
                if(i>-1) h[i]=d;
            } else {
                h.unshift(d);
                currentId = d.id; // Set ID agar tidak duplikat jika ditekan save lagi
            }
            
            localStorage.setItem('m_v9',JSON.stringify(h));
        }

        function loadHistoryList() {
            const h=JSON.parse(localStorage.getItem('m_v9')||'[]');
            const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
            const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
            
            document.getElementById('history-list').innerHTML=h.map(d => {
                const dateObj = new Date(d.date);
                const dateStr = d.date ? `${days[dateObj.getDay()]}, ${dateObj.getDate()} ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}` : 'Tanpa Tanggal';
                
                return `
                <div class="history-item" onclick="openForm(${d.id})">
                    <div>
                        <div style="font-weight:bold; font-size:16px;">${dateStr}</div>
                        <div style="font-size:12px; color:#64748b; margin-top:4px;">${d.shift}</div>
                        <div style="font-size:12px; font-weight:bold; color:var(--primary); margin-top:4px;">Total Hauling: ${d.totalTrip}</div>
                    </div>
                    <div style="font-size:20px; color:#cbd5e1;">‚úèÔ∏è</div>
                </div>`;
            }).join('');
            document.getElementById('empty-msg').style.display=h.length?'none':'block';
        }

        function loadFormData(id) {
            const d=JSON.parse(localStorage.getItem('m_v9')).find(x=>x.id===id); if(!d)return;
            resetForm(); document.getElementById('inpDate').value=d.date; document.getElementById('inpShift').value=d.shift;
            const sC=(b,a)=>document.querySelectorAll(`#${b} input`).forEach(i=>{if(a.includes(i.value))i.checked=true;});
            sC('box-spv',d.spv); document.getElementById('inpSpvM').value=d.spv_m;
            sC('box-frm',d.frm); document.getElementById('inpFrmM').value=d.frm_m;
            sC('box-chk',d.chk); document.getElementById('inpChkM').value=d.chk_m;
            document.getElementById('inpTip').value=d.rom.tip; document.getElementById('inpTrans').value=d.rom.trans;
            convData=d.conv; renderConvRows(masters.conv[0]);
            masters.pt.forEach(p=>{ if(d.pt[p]){ document.getElementById(`run-s-${p}`).value=d.pt[p].rs; document.getElementById(`trip-s-${p}`).value=d.pt[p].ts; document.getElementById(`run-m-${p}`).value=d.pt[p].rm; document.getElementById(`trip-m-${p}`).value=d.pt[p].tm; calcHauling(p); }});
            sdtData=d.sdt; renderSdt();
        }

        function renderSettings() {
            const ren=(k,a)=>document.getElementById(`list-m-${k}`).innerHTML=a.map((x,i)=>`<div class="master-list-item"><span>${x}</span><button onclick="delM('${k}',${i})" class="btn-del">Hapus</button></div>`).join('');
            ren('spv',masters.spv); ren('frm',masters.frm); ren('chk',masters.chk); ren('conv',masters.conv); ren('pt',masters.pt); ren('unit',masters.unit); ren('driver',masters.driver);
        }

        // --- COPY REPORT ---
        function copyReport(isMalam) {
            // AUTO SAVE FIRST
            saveData();

            const fmtDate = (ds) => { if(!ds) return '-'; const d = new Date(ds); const m = ["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGU","SEP","OKT","NOV","DES"]; return `${d.getDate()}/${m[d.getMonth()]}/${d.getFullYear().toString().substr(-2)}`; };
            const joinArr = (box, man) => { const arr = Array.from(document.querySelectorAll(`#${box} input:checked`)).map(e => e.value); const m = document.getElementById(man).value.trim(); if(m) arr.push(m); return arr.join(', '); };
            const valNum = (id) => parseFloat(document.getElementById(id).value)||0;

            const shift = document.getElementById('inpShift').value;
            const dateStr = document.getElementById('inpDate').value;
            
            let txt = `*CHP OPERATION*\n*${shift}*\n*${fmtDate(dateStr)}*\n\n`;
            txt += `*Supervisor* : ${joinArr('box-spv','inpSpvM')}\n`;
            txt += `*Foreman* : ${joinArr('box-frm','inpFrmM')}\n`;
            txt += `*Checker* : ${joinArr('box-chk','inpChkM')}\n\n`;

            txt += `*Efektivitas RUNNING*\n`;
            masters.conv.forEach(sd => {
                let tot=0; (convData[sd]||[]).forEach(d => { if(d.sh){ let s=parseInt(d.sh)*60+parseInt(d.sm), f=parseInt(d.fh)*60+parseInt(d.fm); if(f<s) f+=1440; tot+=(f-s); }});
                const th=Math.floor(tot/60), tm=tot%60;
                if(tot === 0) txt += `- ${sd} = -\n`;
                else txt += `- ${sd} = ${th} Jam ${tm} Menit\n`;
            });

            txt += `\n*HAULING*\n`;
            let totalHauling = 0;
            masters.pt.forEach(pt => {
                const ts = valNum(`trip-s-${pt}`), tm = valNum(`trip-m-${pt}`);
                const tripResult = isMalam ? (tm - ts) : ts;
                totalHauling += tripResult;
                txt += `- ${pt.padEnd(5)} = ${tripResult > 0 ? tripResult + ' TRIP' : '- TRIP'}\n`;
            });

            txt += `\n*UNIT 2 TRIP*\n`;
            masters.pt.forEach(pt => {
                 const resId = isMalam ? `res-m-${pt}` : `res-s-${pt}`;
                 const val = document.getElementById(resId).innerText;
                 txt += `- ${pt.padEnd(5)} = ${val != '0' ? val + ' Unit' : '- Unit'}\n`;
            });

            txt += `\n*TRIP SDT TRANSFER*\n`;
            if(sdtData.length === 0) txt += `-\n`;
            else sdtData.forEach(d => txt += `- ${d.unit} (${d.driver||'-'}) : ${d.trip||'-'} Trip ${d.ket?`*${d.ket}*`:''}\n`);

            const tip = valNum('inpTip');
            const trans = valNum('inpTrans');
            const totalAll = trans + totalHauling;

            txt += `\n\n*TOTAL HAULING   = ${totalHauling > 0 ? totalHauling + ' Trip' : '- Trip'}*\n`;
            txt += `*TIPPING ROM        = ${tip > 0 ? tip + ' Trip' : '- Trip'}*\n`;
            txt += `*TRANSFER ROM   = ${trans > 0 ? trans + ' Trip' : '- Trip'}*\n`;
            txt += `*TRANSFER ROM + HAULING = ${totalAll > 0 ? totalAll + ' Trip' : '- Trip'}*\n`;

            const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select();
            document.execCommand('copy'); document.body.removeChild(ta);
            alert("Laporan Disalin & Disimpan ke Riwayat!");
        }
    </script>
</body>
</html>
